<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forum ‚Äì HFU Buddy</title>
  <link rel="icon" type="image/x-icon" href="logo.png">
  <!-- Google Fonts - Inder Schriftart -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inder&display=swap" rel="stylesheet">
  <style>
    /* ========== GLOBALE STYLES ========== */
    *{margin:0;padding:0;box-sizing:border-box;}
    
    /* Body: Zentrierter Container mit Hintergrund */
    body{
      font-family:'Inder', sans-serif;
      background:#E7DBB5;
      display:flex;justify-content:center;align-items:center;
      min-height:100vh;
      position:relative;
    }
    
    /* Hintergrundbild mit 30% Opazit√§t */
    body::before{
      content:"";
      position:fixed;
      top:0;left:0;
      width:100%;height:100%;
      background-image:url('Hintergrund.png');
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      opacity:0.3;
      z-index:0;
    }
    
    /* ========== PHONE CONTAINER ========== */
    /* Handy-Display Simulation (375x667px) */
    .phone{
      width:100%;max-width:375px;
      height:100vh;max-height:667px;
      background:rgba(231, 219, 181, 0.95);
      display:flex;flex-direction:column;
      box-shadow:0 4px 6px rgba(0,0,0,0.1);
      position:relative;
      z-index:1;
    }
    
    /* ========== TOP BAR ========== */
    /* Obere Leiste mit Zur√ºck-Button, Titel und Benachrichtigungen */
    .top-bar{
      position:relative;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:16px;
      min-height:56px;
      border-bottom:1px solid #D2C79C;
      background:rgba(231, 219, 181, 0.8);
      backdrop-filter: blur(10px);
    }
    
    /* Zur√ºck-Pfeil Icon (links oben) */
    .back-icon{
      position:absolute;
      left:16px;
      height:20px;
      cursor:pointer;
    }
    
    /* "Forum" Titel in der Mitte */
    .top-title{
      font-weight:bold;
      font-size:24px;
      color:#4A7856;
    }
    .notification-icon{
      position:absolute;
      right:20px;
      top:50%;
      transform:translateY(-50%);
      height:30px;
      cursor:pointer;
      border-radius:6px;
      transition:all 0.2s ease;
    }
    .notification-icon:hover{
      transform:translateY(-50%) scale(1.1);
      background:rgba(47, 127, 81, 0.1);
    }
    .content{
      flex:1;padding:16px;overflow-y:auto;
    }
    .post{
      margin-bottom:16px;
      border:1px solid #D2C79C;
      border-radius:8px;
      padding:14px;
      padding-bottom:50px;
      background:rgba(245, 240, 220, 0.75);
      backdrop-filter: blur(5px);
      box-shadow:0 2px 4px rgba(0,0,0,0.05);
      position:relative;
    }
    .post-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:6px;
    }
    .post-title-area{
      flex:1;
    }
    .post-title{
      font-weight:bold;color:#2F5F3F;
      font-size:20px;
    }
    .save-btn-top{
      border:none;background:none;
      cursor:pointer;
      padding:4px;
      transition:all 0.2s ease;
      border-radius:6px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .save-btn-top:hover{
      transform:scale(1.15);
      background:rgba(47, 127, 81, 0.1);
    }
    .post-author{
      font-size:15px;color:#4A6B51;margin-bottom:4px;
    }
    .post-time{
      font-size:13px;color:#7A8B81;margin-bottom:8px;
    }
    .post-text{
      font-size:16px;line-height:1.6;
      margin-bottom:12px;color:#2F5F3F;
    }
    .post-actions{
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:8px;
      padding-top:10px;
      border-top:1px solid #E7DBB5;
    }
    .icon-btn{
      border:none;background:none;
      cursor:pointer;
      padding:2px;
      transition:all 0.2s ease;
      border-radius:6px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:2px;
    }
    .icon-btn:hover{
      transform:scale(1.15);
      background:rgba(47, 127, 81, 0.1);
    }
    .icon-small{
      height:22px;width:auto;
    }
    .votes, .comment-count{
      font-size:14px;color:#4A7856;
      font-weight:bold;
      min-width:20px;
      text-align:center;
      padding:0 2px;
    }
    
    /* ========== POST IMAGE STYLES ========== */
    .post-image{
      width:100%;
      max-width:300px;
      height:auto;
      border-radius:8px;
      margin:12px 0;
      display:block;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
      transition:all 0.3s ease;
    }
    .post-image:hover{
      transform:scale(1.05);
      box-shadow:0 4px 8px rgba(0,0,0,0.2);
    }
    
    .plus{
      display:flex;justify-content:center;
      margin:8px 0 12px;
    }
    .plus-btn-img{
      height:50px;
      width:auto;
      cursor:pointer;
      transition:all 0.2s ease;
      filter:drop-shadow(0 4px 6px rgba(0,0,0,0.2));
    }
    .plus-btn-img:hover{
      transform:scale(1.05);
      filter:drop-shadow(0 6px 8px rgba(0,0,0,0.3));
    }
    .bottom-bar{
      height:75px;
      background:rgba(231, 219, 181, 0.75);
      backdrop-filter: blur(10px);
      display:flex;
      justify-content:space-evenly;
      align-items:center;
      border-top:1px solid #D2C79C;
      padding:12px 0;
    }
    .bottom-bar a{ 
      text-decoration:none;
      padding:8px;
      border-radius:8px;
      transition:all 0.2s ease;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .bottom-bar a:hover{
      background:rgba(47, 127, 81, 0.1);
      transform:scale(1.1);
    }
    .nav-icon{ height:36px;width:auto; }
    @media(max-width:600px){
      .phone{max-width:100%;height:100vh;max-height:none;}
    }
  </style>
</head>
<body>
  <div class="phone">
    <div class="top-bar">
      <img src="gback.png" alt="Zur√ºck" class="back-icon" onclick="window.location.href='index.html'" style="cursor:pointer;">
      <div class="top-title">Forum</div>
      <a href="forum_benachrichtigungen.html">
        <img src="gmeldung.png" alt="Benachrichtigungen" class="notification-icon">
      </a>
    </div>

    <div class="content" id="posts-container">
      <!-- Erlk√∂nig Post 1 -->
      <div class="post" data-votes="0" data-post-id="post-2">
        <div class="post-header">
          <div class="post-title-area">
            <div class="post-title">Erlk√∂nig Teil 1</div>
          </div>
          <button class="icon-btn save-btn-top save-btn">
            <img src="gmerken.png" alt="Merken" class="icon-small">
          </button>
        </div>
        <div class="post-author">von Johann</div>
        <div class="post-time">vor 45min</div>
        <div class="post-text">
          Wer reitet so sp√§t durch Nacht und Wind?<br>
          Es ist der Vater mit seinem Kind;<br>
          Er hat den Knaben wohl in dem Arm,<br>
          Er fasst ihn sicher, er h√§lt ihn warm.
        </div>
        <div class="post-actions">
          <button class="icon-btn comment-btn">
            <img src="gkomm.png" alt="Kommentare" class="icon-small">
            <span class="comment-count">0</span>
          </button>
          <button class="icon-btn upvote-btn">
            <img src="gup.png" alt="Upvote" class="icon-small">
            <span class="votes">0</span>
          </button>
        </div>
      </div>

      <div class="post" data-votes="0" data-post-id="post-3">
        <div class="post-header">
          <div class="post-title-area">
            <div class="post-title">Erlk√∂nig Teil 2</div>
          </div>
          <button class="icon-btn save-btn-top save-btn">
            <img src="gmerken.png" alt="Merken" class="icon-small">
          </button>
        </div>
        <div class="post-author">von Wolfgang</div>
        <div class="post-time">vor 2h</div>
        <div class="post-text">
          ‚ÄûMein Sohn, was birgst du so bang dein Gesicht?" ‚Äì<br>
          ‚ÄûSiehst, Vater, du den Erlk√∂nig nicht?<br>
          Den Erlenk√∂nig mit Kron' und Schweif?" ‚Äì<br>
          ‚ÄûMein Sohn, es ist ein Nebelstreif."
        </div>
        <div class="post-actions">
          <button class="icon-btn comment-btn">
            <img src="gkomm.png" alt="Kommentare" class="icon-small">
            <span class="comment-count">0</span>
          </button>
          <button class="icon-btn upvote-btn">
            <img src="gup.png" alt="Upvote" class="icon-small">
            <span class="votes">0</span>
          </button>
        </div>
      </div>
    </div>

    <!-- ========== PLUS BUTTON - Neuen Post erstellen ========== -->
    <div class="plus">
      <a href="forum_posten.html" id="plusBtn">
        <img src="plus.png" alt="Neuer Post" class="plus-btn-img">
      </a>
    </div>

    <div class="bottom-bar">
      <a href="einstellungen.html">
        <img src="geinstellungen.png" alt="Einstellungen" class="nav-icon">
      </a>
      <a href="index.html">
        <img src="ghome.png" alt="Home" class="nav-icon">
      </a>
      <a href="forum_merken.html">
        <img src="gmerken.png" alt="Merken" class="nav-icon">
      </a>
    </div>
  </div>

  <script>
    /* ========== NAVIGATION SETUP ========== */
    /* Setze forumReferrer sofort beim Laden, damit Kommentare zur√ºck zu Forum f√ºhren */
    sessionStorage.setItem('forumReferrer', 'forum.html');
    
    /* Plus-Button: √ñffnet "Neuen Post erstellen" Seite */
    document.getElementById('plusBtn').addEventListener('click', function(e) {
      localStorage.setItem('postSourcePage', 'forum'); // Merke, dass Post von Forum kommt
      sessionStorage.setItem('forumReferrer', 'forum.html'); // Zur√ºck-Navigation
    });
    
    /* ========== FAKE KOMMENTARE INITIALISIEREN ========== */
    /* Erstellt vordefinierte Kommentare f√ºr die Beispiel-Posts beim ersten Laden */
    function initializeForumComments() {
      const initialized = localStorage.getItem('forumCommentsInit');
      if(initialized === 'true') return; // Bereits initialisiert, nichts tun
      
      const existingComments = localStorage.getItem('postComments');
      const postComments = existingComments ? JSON.parse(existingComments) : {};
      
      // Post 1: "Neuer Post-Button" - 2 Kommentare
      postComments["post-1"] = [
        { id: 0, author: "DesignLover", text: "Cool, der Button sieht super aus! üòä", replies: [] },
        { id: 1, author: "NewUser", text: "Danke f√ºr die Erkl√§rung, jetzt wei√ü ich wie es geht!", replies: [] }
      ];
      
      // Post 2: "Erlk√∂nig Teil 1" - 3 Kommentare
      postComments["post-2"] = [
        { id: 0, author: "LiteraturFan", text: "Eines der bekanntesten Gedichte √ºberhaupt!", replies: [] },
        { id: 1, author: "Goethe_Kenner", text: "Die Atmosph√§re ist wirklich einzigartig.", replies: [] },
        { id: 2, author: "Sch√ºlerHelfer", text: "Mussten wir auswendig lernen in der Schule", replies: [] }
      ];
      
      // Post 3: "Erlk√∂nig Teil 2" - 2 Kommentare
      postComments["post-3"] = [
        { id: 0, author: "DeutschProfi", text: "Der Dialog ist so meisterhaft geschrieben", replies: [] },
        { id: 1, author: "Balladenfan", text: "Die Spannung steigt mit jeder Zeile!", replies: [] }
      ];
      
      // Speichere Kommentare in localStorage
      localStorage.setItem("postComments", JSON.stringify(postComments));
      localStorage.setItem('forumCommentsInit', 'true'); // Markiere als initialisiert
    }
    
    initializeForumComments(); // Fake-Kommentare beim Laden erstellen
    
    const container = document.getElementById("posts-container");

    /* ========== NEUE POSTS LADEN ========== */
    /* L√§dt benutzerdefinierte Posts aus sessionStorage (erstellt in forum_posten.html) */
    const newPostsRaw = sessionStorage.getItem('newPosts');
    if(newPostsRaw) {
      try {
        const newPosts = JSON.parse(newPostsRaw);
        // Nur Posts anzeigen, die von 'forum' Seite erstellt wurden
        newPosts.forEach((p, index) => {
          if(p.sourcePage === 'forum' || !p.sourcePage) {
            const postId = 'new-forum-' + index;
            const newPost = document.createElement('div');
            newPost.className = 'post';
            newPost.dataset.postId = postId;
            newPost.dataset.votes = '0';
            newPost.innerHTML = `
              <div class="post-header">
                <div class="post-title-area">
                  <div class="post-title">${p.title || 'Neuer Post'}</div>
                </div>
                <button class="icon-btn save-btn-top save-btn">
                  <img src="gmerken.png" alt="Merken" class="icon-small">
                </button>
              </div>
              <div class="post-author">von ${p.name || 'Anonym'}</div>
              <div class="post-time">vor 1min</div>
              <div class="post-text">${p.text}</div>
              <div class="post-actions">
                <button class="icon-btn comment-btn">
                  <img src="gkomm.png" alt="Kommentare" class="icon-small">
                  <span class="comment-count">0</span>
                </button>
                <button class="icon-btn upvote-btn">
                  <img src="gup.png" alt="Upvote" class="icon-small">
                  <span class="votes">0</span>
                </button>
              </div>
            `;
            container.insertBefore(newPost, container.firstChild);
          }
        });
      } catch(e) {}
    }

    /* ========== KOMMENTAR-BUTTONS ========== */
    /* Beim Klick auf Kommentar-Button: √ñffne Kommentar-Ansicht */
    document.querySelectorAll(".comment-btn").forEach(btn => {
      btn.addEventListener("click", function() {
        const post = this.closest(".post");
        const postId = post.dataset.postId;
        if(postId) {
          localStorage.setItem("currentPostId", postId); // Speichere welcher Post angezeigt werden soll
          sessionStorage.setItem('forumReferrer', 'forum.html'); // Zur√ºck-Navigation zu Forum
          sessionStorage.removeItem('fromNotification'); // L√∂sche Benachrichtigungs-Flag
          window.location.href = "forum_kommentare.html"; // √ñffne Kommentare
        }
      });
    });

    /* ========== UPVOTE SYSTEM ========== */
    /* Erm√∂glicht das Upvoten von Posts - Posts mit mehr Votes werden nach oben sortiert */
    const posts = Array.from(container.querySelectorAll(".post"));
    posts.forEach(post => {
      const btn = post.querySelector(".upvote-btn");
      const votesSpan = post.querySelector(".votes");
      if(btn && votesSpan) {
        btn.addEventListener("click", () => {
          // Erh√∂he Vote-Z√§hler
          let votes = parseInt(post.dataset.votes || "0", 10);
          votes++;
          post.dataset.votes = votes;
          votesSpan.textContent = votes;
          
          // Sortiere Posts nach Votes (h√∂chste zuerst)
          const sorted = posts.slice().sort(
            (a,b)=>parseInt(b.dataset.votes||"0",10)-parseInt(a.dataset.votes||"0",10)
          );
          sorted.forEach(p=>container.appendChild(p));
        });
      }
    });

    function savePostData(title, author, text, postId){
      let saved=[];
      const raw=sessionStorage.getItem("savedPosts");
      if(raw){ try{saved=JSON.parse(raw);}catch(e){saved=[];} }
      saved.push({title,author,text,postId});
      sessionStorage.setItem("savedPosts",JSON.stringify(saved));
    }
    
    container.querySelectorAll(".post .save-btn").forEach(saveBtn=>{
      saveBtn.addEventListener("click",function(){
        const post = this.closest(".post");
        const title=post.querySelector(".post-title").innerHTML;
        const author=post.querySelector(".post-author").innerHTML;
        const text=post.querySelector(".post-text").innerHTML;
        const postId=post.dataset.postId;
        savePostData(title,author,text,postId);
        alert("Post gespeichert!");
      });
    });

    /* ========== BENACHRICHTIGUNGS-ICON & KOMMENTAR-Z√ÑHLER ========== */
    /* Beim Laden der Seite: Icon aktualisieren und Kommentar-Counts berechnen */
    window.addEventListener("DOMContentLoaded", () => {
      const saved = localStorage.getItem("hasNotifications");
      if(saved === "true") {
        const icon = document.querySelector(".notification-icon");
        if(icon) icon.src = "punkt.png"; // Roter Punkt bei neuen Benachrichtigungen
      }
      
      updateCommentCounts(); // Aktualisiere Kommentar-Zahlen
    });
    
    /* ========== KOMMENTAR-Z√ÑHLER AKTUALISIEREN ========== */
    /* Liest aus localStorage wie viele Kommentare jeder Post hat und zeigt die Zahl an */
    function updateCommentCounts() {
      const postCommentsRaw = localStorage.getItem("postComments");
      if(!postCommentsRaw) return; // Keine Kommentare vorhanden
      
      try {
        const postComments = JSON.parse(postCommentsRaw);
        document.querySelectorAll(".post").forEach(post => {
          const postId = post.dataset.postId;
          if(postId && postComments[postId]) {
            const countSpan = post.querySelector(".comment-count");
            if(countSpan) {
              // Z√§hle alle Kommentare + verschachtelte Antworten
              countSpan.textContent = countAllComments(postComments[postId]);
            }
          }
        });
      } catch(e) {}
    }
    
    /* Rekursive Funktion: Z√§hlt Kommentare + alle Antworten (Replies) */
    function countAllComments(comments) {
      let total = comments.length;
      comments.forEach(c => {
        if(c.replies && c.replies.length > 0) {
          total += countAllComments(c.replies);
        }
      });
      return total;
    }
    
    // Aktualisiere Kommentarzahlen bei jedem Seitenaufruf
    updateCommentCounts();
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kommentare</title>
  <link rel="icon" type="image/x-icon" href="logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inder&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:'Inder', sans-serif;
      background:#E7DBB5;
      display:flex;justify-content:center;align-items:center;
      min-height:100vh;
      position:relative;
    }
    body::before{
      content:"";
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background-image:url('Hintergrund.png');
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      opacity:0.3;
      z-index:0;
    }
    .phone{
      width:100%;max-width:375px;
      height:100vh;max-height:667px;
      background:rgba(231, 219, 181, 0.95);
      display:flex;flex-direction:column;
      box-shadow:0 4px 6px rgba(0,0,0,0.1);
      position:relative;
      z-index:1;
    }

    .top-bar{
      position:relative;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:16px 16px;
      min-height:56px;
      border-bottom:1px solid #D2C79C;
      background:rgba(231, 219, 181, 0.8);
      backdrop-filter: blur(10px);
    }
    .back-icon{
      position:absolute;
      left:16px;
      height:20px;
      width:auto;
      cursor:pointer;
    }
    .top-title{
      font-weight:bold;
      font-size:24px;
      color:#2F7F51;
    }
    .notification-icon{
      position:absolute;
      right:20px;
      top:50%;
      transform:translateY(-50%);
      height:30px;
      width:auto;
      cursor:pointer;
      border-radius:6px;
      transition:all 0.2s ease;
    }
    .notification-icon:hover{
      transform:translateY(-50%) scale(1.1);
      background:rgba(47, 127, 81, 0.1);
    }

    .content{
      flex:1;padding:12px;overflow-y:auto;
    }
    .comment-box{
      background:rgba(245, 238, 208, 0.8);
      backdrop-filter: blur(5px);
      padding:12px;
      border-radius:6px;
      margin-bottom:10px;
      font-size:16px;
      color:#4A7856;
      line-height:1.6;
    }
    .author{
      font-weight:bold;
      color:#4A7856;
      margin-bottom:6px;
      font-size:17px;
    }
    .comment-actions{
      margin-top:8px;
      display:flex;
      gap:12px;
      align-items:center;
    }
    .reply-btn{
      font-size:14px;
      color:#4A7856;
      cursor:pointer;
      background:none;
      border:none;
      text-decoration:underline;
      padding:0;
      font-weight:bold;
    }
    .reply-btn:hover{
      color:#5A8866;
    }
    .replies{
      margin-left:20px;
      margin-top:8px;
      border-left:2px solid rgba(74, 120, 86, 0.3);
      padding-left:12px;
    }
    .reply-box{
      background:rgba(235, 228, 198, 0.8);
      backdrop-filter: blur(5px);
      padding:10px;
      border-radius:6px;
      margin-bottom:8px;
      font-size:15px;
      color:#4A7856;
      line-height:1.5;
    }
    .reply-input-area{
      margin-top:8px;
      display:none;
      flex-direction:column;
      gap:6px;
    }
    .reply-input-area.active{
      display:flex;
    }
    .reply-input-area input,
    .reply-input-area textarea{
      border:1px solid #D2C79C;
      border-radius:6px;
      padding:6px;
      font-size:15px;
      font-family:Arial,sans-serif;
      color:#4A7856;
    }
    .reply-input-area textarea{
      resize:vertical;
      min-height:40px;
    }
    .reply-send-btn{
      align-self:flex-end;
      border:none;
      border-radius:12px;
      padding:4px 12px;
      background:#4A7856;
      color:#E7DBB5;
      font-size:15px;
      cursor:pointer;
      font-weight:bold;
    }
    .cancel-reply-btn{
      align-self:flex-end;
      border:none;
      border-radius:12px;
      padding:4px 12px;
      background:#999;
      color:#fff;
      font-size:15px;
      cursor:pointer;
      margin-left:6px;
    }
    .input-area{
      padding:10px 12px;
      border-top:1px solid #D2C79C;
      background:rgba(231, 219, 181, 0.8);
      backdrop-filter: blur(10px);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .input-area input,
    .input-area textarea{
      border:1px solid #D2C79C;
      border-radius:6px;
      padding:8px;
      font-size:16px;
      font-family:Arial,sans-serif;
      color:#4A7856;
    }
    textarea{resize:vertical;min-height:50px;}
    .send-btn{
      align-self:flex-end;
      border:none;
      border-radius:16px;
      padding:6px 14px;
      background:#4A7856;
      color:#E7DBB5;
      font-size:16px;
      cursor:pointer;
      font-weight:bold;
    }

    .bottom-bar{
      height:75px;
      background:rgba(231, 219, 181, 0.75);
      backdrop-filter: blur(10px);
      display:flex;
      justify-content:space-evenly;
      align-items:center;
      border-top:1px solid #D2C79C;
      padding:12px 0;
    }
    .bottom-bar a{ 
      text-decoration:none;
      padding:8px;
      border-radius:8px;
      transition:all 0.2s ease;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .bottom-bar a:hover{
      background:rgba(47, 127, 81, 0.1);
      transform:scale(1.1);
    }
    .nav-icon{ height:36px;width:auto; }

    @media(max-width:600px){
      .phone{max-width:100%;height:100vh;max-height:none;}
    }
  </style>
</head>
<body>
  <div class="phone">
    <div class="top-bar">
      <img src="gback.png" alt="Zurück" class="back-icon" id="backBtn" style="cursor:pointer;">
      <div class="top-title">Kommentare</div>
      <a href="forum_benachrichtigungen.html">
        <img src="gmeldung.png" alt="Benachrichtigungen" class="notification-icon">
      </a>
    </div>

    <div id="comments" class="content">
      <!-- Kommentare werden hier dynamisch geladen -->
    </div>

    <div class="input-area">
      <input id="nameInput" type="text" placeholder="Name (optional)">
      <textarea id="commentInput" placeholder="Kommentar schreiben..."></textarea>
      <button class="send-btn" id="sendBtn">Senden</button>
    </div>

    <div class="bottom-bar">
      <a href="einstellungen.html">
        <img src="geinstellungen.png" alt="Einstellungen" class="nav-icon">
      </a>
      <a href="index.html">
        <img src="ghome.png" alt="Home" class="nav-icon">
      </a>
      <a href="forum_merken.html">
        <img src="gmerken.png" alt="Merken" class="nav-icon">
      </a>
    </div>
  </div>

  <script>
    /* ========== DOM ELEMENTE REFERENZIEREN ========== */
    const commentsContainer = document.getElementById('comments'); // Container für alle Kommentare
    const nameInput = document.getElementById('nameInput'); // Eingabefeld für Namen
    const commentInput = document.getElementById('commentInput'); // Textarea für Kommentar-Text
    const sendBtn = document.getElementById('sendBtn'); // Senden-Button
    
    /* ========== GLOBALE VARIABLEN ========== */
    let commentIdCounter = 0; // Zähler für eindeutige Kommentar-IDs
    let currentPostId = localStorage.getItem('currentPostId') || 'post-1'; // ID des aktuellen Posts
    
    /* ========== KOMMENTARE LADEN ========== */
    // Lädt alle Kommentare für den aktuellen Post aus localStorage und zeigt sie an
    /* ========== KOMMENTARE LADEN ========== */
    // Lädt alle Kommentare für den aktuellen Post aus localStorage und zeigt sie an
    function loadComments() {
      // localStorage auslesen - enthält alle Kommentare für alle Posts
      const allCommentsRaw = localStorage.getItem('postComments');
      if(!allCommentsRaw) {
        initializeDefaultComments(); // Falls keine Kommentare vorhanden, initialisiere leeres Objekt
        return;
      }
      
      try {
        const allComments = JSON.parse(allCommentsRaw); // JSON String in Objekt umwandeln
        const postComments = allComments[currentPostId] || []; // Nur Kommentare für aktuellen Post holen
        
        // Jeden Kommentar rendern (anzeigen)
        postComments.forEach(comment => {
          renderComment(comment, commentsContainer);
        });
        
        // ID-Counter aktualisieren: Höchste ID finden + 1
        if(postComments.length > 0) {
          commentIdCounter = Math.max(...postComments.map(c => getMaxId(c)), 0) + 1;
        }
      } catch(e) {
        initializeDefaultComments(); // Bei Fehler (z.B. korrupte Daten) neu initialisieren
      }
    }
    
    /* ========== HÖCHSTE ID REKURSIV FINDEN ========== */
    // Findet die höchste ID in einem Kommentar und allen seinen Antworten (rekursiv)
    /* ========== HÖCHSTE ID REKURSIV FINDEN ========== */
    // Findet die höchste ID in einem Kommentar und allen seinen Antworten (rekursiv)
    function getMaxId(comment) {
      let maxId = comment.id || 0; // Starte mit der ID des Kommentars
      // Durchsuche alle Antworten rekursiv
      if(comment.replies && comment.replies.length > 0) {
        comment.replies.forEach(reply => {
          const replyMaxId = getMaxId(reply); // Rekursiver Aufruf für Antworten
          if(replyMaxId > maxId) maxId = replyMaxId;
        });
      }
      return maxId;
    }
    
    /* ========== LEERES KOMMENTAR-OBJEKT INITIALISIEREN ========== */
    // Erstellt ein leeres Kommentar-Objekt in localStorage
    /* ========== LEERES KOMMENTAR-OBJEKT INITIALISIEREN ========== */
    // Erstellt ein leeres Kommentar-Objekt in localStorage
    function initializeDefaultComments() {
      const defaultComments = {}; // Leeres Objekt: wird später Posts als Keys bekommen
      localStorage.setItem('postComments', JSON.stringify(defaultComments));
      commentIdCounter = 0; // Counter auf 0 setzen
    }
    
    /* ========== KOMMENTAR ANZEIGEN ========== */
    // Erstellt HTML-Element für einen Kommentar und fügt es dem Container hinzu
    /* ========== KOMMENTAR ANZEIGEN ========== */
    // Erstellt HTML-Element für einen Kommentar und fügt es dem Container hinzu
    function renderComment(comment, container, isReply = false) {
      const box = document.createElement('div');
      box.className = isReply ? 'reply-box' : 'comment-box'; // Verschiedene CSS-Klassen für Kommentar vs. Antwort
      box.dataset.commentId = comment.id; // ID als data-Attribut speichern für spätere Suche
      
      // HTML-Inhalt des Kommentars erstellen
      box.innerHTML = `
        <div class="author">${comment.author}</div>
        <div>${comment.text}</div>
        <div class="comment-actions">
          <button class="reply-btn" onclick="toggleReplyInput(${comment.id})">Antworten</button>
        </div>
        <div class="reply-input-area" id="reply-input-${comment.id}">
          <input type="text" placeholder="Name (optional)" class="reply-name-input">
          <textarea placeholder="Antwort schreiben..." class="reply-text-input"></textarea>
          <div>
            <button class="reply-send-btn" onclick="sendReply(${comment.id})">Senden</button>
            <button class="cancel-reply-btn" onclick="toggleReplyInput(${comment.id})">Abbrechen</button>
          </div>
        </div>
      `;
      
      container.appendChild(box); // Kommentar zum Container hinzufügen
      
      // Rekursiv alle Antworten rendern
      // Rekursiv alle Antworten rendern
      if(comment.replies && comment.replies.length > 0) {
        const repliesContainer = document.createElement('div');
        repliesContainer.className = 'replies'; // Extra Container für Antworten (für Einrückung)
        repliesContainer.dataset.parentId = comment.id; // Parent-ID speichern
        // Für jede Antwort: renderComment rekursiv aufrufen
        comment.replies.forEach(reply => {
          renderComment(reply, repliesContainer, true); // isReply = true
        });
        box.appendChild(repliesContainer); // Antwort-Container zum Kommentar hinzufügen
      }
    }
    
    /* ========== ANTWORT-EINGABEFELD EIN-/AUSBLENDEN ========== */
    // Zeigt oder versteckt das Eingabefeld für Antworten
    /* ========== ANTWORT-EINGABEFELD EIN-/AUSBLENDEN ========== */
    // Zeigt oder versteckt das Eingabefeld für Antworten
    function toggleReplyInput(commentId) {
      const replyArea = document.getElementById(`reply-input-${commentId}`);
      if(replyArea) {
        replyArea.classList.toggle('active'); // Toggle CSS-Klasse 'active' (macht Eingabefeld sichtbar)
      }
    }
    
    /* ========== ANTWORT SENDEN ========== */
    // Erstellt eine neue Antwort und fügt sie dem Parent-Kommentar hinzu
    /* ========== ANTWORT SENDEN ========== */
    // Erstellt eine neue Antwort und fügt sie dem Parent-Kommentar hinzu
    function sendReply(parentId) {
      // Eingabefeld-Elemente finden
      const replyArea = document.getElementById(`reply-input-${parentId}`);
      const nameInput = replyArea.querySelector('.reply-name-input');
      const textInput = replyArea.querySelector('.reply-text-input');
      
      // Werte auslesen und trimmen (Leerzeichen entfernen)
      const name = nameInput.value.trim() || 'Anon'; // Falls leer, 'Anon' verwenden
      const text = textInput.value.trim();
      
      if (!text) return; // Abbrechen wenn kein Text eingegeben wurde
      
      // Neue Antwort als Objekt erstellen
      const newReply = {
        id: commentIdCounter++, // ID vergeben und Counter erhöhen
        author: name,
        text: text,
        replies: [] // Neue Antwort hat noch keine eigenen Antworten
      };
      
      // Alle Kommentare aus localStorage laden
      let allComments = {};
      const savedComments = localStorage.getItem('postComments');
      if(savedComments) {
        try { allComments = JSON.parse(savedComments); } catch(e) { allComments = {}; }
      }
      
      // Sicherstellen, dass Array für aktuellen Post existiert
      if(!allComments[currentPostId]) {
        allComments[currentPostId] = [];
      }
      
      // Antwort zum richtigen Parent-Kommentar hinzufügen (rekursiv)
      addReplyToComment(allComments[currentPostId], parentId, newReply);
      
      // Aktualisierte Kommentare in localStorage speichern
      localStorage.setItem('postComments', JSON.stringify(allComments));
      
      // UI aktualisieren: Antwort sofort anzeigen
      const parentBox = document.querySelector(`[data-comment-id="${parentId}"]`);
      let repliesContainer = parentBox.querySelector(`.replies[data-parent-id="${parentId}"]`);
      
      // Falls noch kein Antwort-Container existiert, erstelle einen
      // Falls noch kein Antwort-Container existiert, erstelle einen
      if(!repliesContainer) {
        repliesContainer = document.createElement('div');
        repliesContainer.className = 'replies';
        repliesContainer.dataset.parentId = parentId;
        parentBox.appendChild(repliesContainer);
      }
      
      // Neue Antwort rendern und anzeigen
      renderComment(newReply, repliesContainer, true);
      
      // Eingabefelder leeren und Eingabebereich schließen
      nameInput.value = '';
      textInput.value = '';
      toggleReplyInput(parentId);
      
      // Benachrichtigung erstellen
      createNotification(name, text, 'Antwort');
    }
    
    /* ========== ANTWORT ZUM PARENT HINZUFÜGEN (REKURSIV) ========== */
    // Durchsucht die Kommentar-Struktur rekursiv und fügt Antwort zum richtigen Parent hinzu
    /* ========== ANTWORT ZUM PARENT HINZUFÜGEN (REKURSIV) ========== */
    // Durchsucht die Kommentar-Struktur rekursiv und fügt Antwort zum richtigen Parent hinzu
    function addReplyToComment(comments, parentId, reply) {
      for(let comment of comments) {
        // Wenn dies der gesuchte Parent ist, Antwort hinzufügen
        if(comment.id === parentId) {
          if(!comment.replies) comment.replies = []; // Falls noch kein replies-Array existiert
          comment.replies.push(reply); // Antwort hinzufügen
          return true; // Erfolgreich gefunden und hinzugefügt
        }
        // Rekursiv in den Antworten des aktuellen Kommentars suchen
        if(comment.replies && comment.replies.length > 0) {
          if(addReplyToComment(comment.replies, parentId, reply)) {
            return true; // In tieferen Ebenen gefunden
          }
        }
      }
      return false; // Parent nicht gefunden
    }
    
    /* ========== BENACHRICHTIGUNG ERSTELLEN ========== */
    // Erstellt eine neue Benachrichtigung und speichert sie in localStorage
    /* ========== BENACHRICHTIGUNG ERSTELLEN ========== */
    // Erstellt eine neue Benachrichtigung und speichert sie in localStorage
    function createNotification(author, text, type = 'Kommentar') {
      // Bestehende Benachrichtigungen laden
      let notifications = [];
      const saved = localStorage.getItem('notifications');
      if(saved) {
        try { notifications = JSON.parse(saved); } catch(e) { notifications = []; }
      }
      
      // Neue Benachrichtigung erstellen
      const notification = {
        type: 'comment',
        message: `Neuer ${type} zum Post`,
        author: author,
        text: text,
        timestamp: new Date().toLocaleString('de-DE'), // Deutsches Datumsformat
        link: 'forum_kommentare.html'
      };
      
      notifications.push(notification); // Zur Liste hinzufügen
      localStorage.setItem('notifications', JSON.stringify(notifications)); // Speichern
      
      // Benachrichtigungs-Icon auf allen Seiten aktivieren
      localStorage.setItem('hasNotifications', 'true');
      const icon = document.querySelector('.notification-icon');
      if(icon) icon.src = 'punkt.png'; // Icon sofort auf dieser Seite ändern
    }
    
    /* ========== KOMMENTARE BEIM START LADEN ========== */
    loadComments(); // Funktion ausführen sobald Script geladen wird

    /* ========== HAUPT-KOMMENTAR SENDEN ========== */
    // Event Listener für den Senden-Button (für Haupt-Kommentare, nicht Antworten)
    /* ========== HAUPT-KOMMENTAR SENDEN ========== */
    // Event Listener für den Senden-Button (für Haupt-Kommentare, nicht Antworten)
    sendBtn.addEventListener('click', () => {
      // Eingabewerte auslesen
      const name = nameInput.value.trim() || 'Anon';
      const text = commentInput.value.trim();
      if (!text) return; // Abbrechen wenn kein Text

      // Neuen Kommentar erstellen
      const newComment = {
        id: commentIdCounter++,
        author: name,
        text: text,
        replies: []
      };
      
      // Sofort in UI anzeigen
      renderComment(newComment, commentsContainer);
      
      // Eingabefelder leeren
      commentInput.value = '';
      nameInput.value = '';
      
      // Kommentar für aktuellen Post in localStorage speichern
      let allComments = {};
      const savedComments = localStorage.getItem('postComments');
      if(savedComments) {
        try { allComments = JSON.parse(savedComments); } catch(e) { allComments = {}; }
      }
      
      // Sicherstellen dass Array für Post existiert
      if(!allComments[currentPostId]) {
        allComments[currentPostId] = [];
      }
      
      // Neuen Kommentar am Anfang einfügen (neueste zuerst)
      allComments[currentPostId].unshift(newComment);
      localStorage.setItem('postComments', JSON.stringify(allComments));
      
      // Benachrichtigung erstellen
      createNotification(name, text);
      
      // Seite neu laden um korrekte Reihenfolge zu gewährleisten
      location.reload();
    });
    
    /* ========== SEITE GELADEN - INITIALISIERUNG ========== */
    /* ========== SEITE GELADEN - INITIALISIERUNG ========== */
    window.addEventListener('DOMContentLoaded', () => {
      // Benachrichtigungs-Icon Status prüfen und ggf. aktualisieren
      const saved = localStorage.getItem('hasNotifications');
      if(saved === 'true') {
        const icon = document.querySelector('.notification-icon');
        if(icon) icon.src = 'punkt.png'; // Rotes Icon mit Punkt anzeigen
      }
      
      // Zurück-Button: Geht IMMER zu forum.html (hart-codiert)
      const backBtn = document.getElementById('backBtn');
      if(backBtn) {
        backBtn.addEventListener('click', () => {
          window.location.href = 'forum.html'; // Feste Navigation, unabhängig von forumReferrer
        });
      }
    });
  </script>
</body>
</html>
